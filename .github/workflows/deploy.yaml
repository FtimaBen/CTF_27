name: Build & Deploy Private Repo to GitHub Pages

on:
  workflow_dispatch:   # manual trigger
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout private repo
      - name: Checkout Private Repo
        uses: actions/checkout@v4
        with:
          repository: FtimaBen/CTF   
          token: ${{ secrets.SEC_TKEN }}
          path: private-repo

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3. Install tools
      - name: Install Tools
        run: |
          npm install -g javascript-obfuscator html-minifier-terser

      # Obfuscate JS without renaming globals
      - name: Obfuscate JS
        run: |
          mkdir -p build/js
          for file in private-repo/src/js/*.js; do
            base=$(basename "$file")
            javascript-obfuscator "$file" \
              --output "build/js/$base" \
              --compact true \
              --self-defending true \
              --control-flow-flattening true \
              --string-array true \
              --string-array-encoding base64 \
              --rename-globals false
          done


      # 5. Copy HTML and update JS references directly into build root
      - name: Copy HTML & update JS references
        run: |
          mkdir -p build
          for html in private-repo/src/html/*.html; do
            out="build/$(basename "$html")"
            cp "$html" "$out"
            for jsfile in private-repo/src/js/*.js; do
              jsbase=$(basename "$jsfile")
              sed -i "s|src=\"[^\"]*$jsbase\"|src=\"js/$jsbase\"|g" "$out"
            done
          done

      # 6. Minify HTML in-place
      - name: Minify HTML
        run: |
          for html in build/*.html; do
            html-minifier-terser "$html" -o "$html" \
              --collapse-whitespace --remove-comments --minify-css true --minify-js true
          done

      # 7. Copy media folder
      - name: Copy media
        run: |
          mkdir -p build/media
          cp -r private-repo/src/media/* build/media/

      # 9. Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          publish_branch: gh-pages
